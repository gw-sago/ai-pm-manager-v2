---
description: PM役としてREPORTをレビューします
argument-hint: PROJECT_NAME REPORT_NUMBER [--list|--next|--batch|--all|--script]
---

PMとして指定されたプロジェクトの REPORT をレビューします。

## スクリプトモード（--script）

`--script` オプションを指定すると、親スクリプトによる一括実行モードになります。

```bash
# 構文
python backend/review/process_review.py PROJECT_NAME TASK_ID [options]

# 実行例
python backend/review/process_review.py AI_PM_PJ TASK_605

# ドライラン（実行計画のみ表示）
python backend/review/process_review.py AI_PM_PJ TASK_605 --dry-run

# AI処理をスキップ（自動承認）
python backend/review/process_review.py AI_PM_PJ TASK_605 --skip-ai

# レビューなしで自動承認
python backend/review/process_review.py AI_PM_PJ TASK_605 --auto-approve
```

### スクリプトモードの利点

| 項目 | 従来方式 | スクリプトモード |
|------|---------|----------------|
| ツール呼び出し回数 | 5-10回/処理 | 1回 |
| フロー漏れリスク | あり | なし（Python保証） |
| トークン消費 | 高 | 50-70%削減 |
| バックグラウンド実行 | 不安定 | 安定 |

### 内部処理フロー

```
process_review.py
  │
  ├─ Step 1: タスク・REPORT情報取得
  ├─ Step 2: IN_REVIEW更新
  ├─ Step 3: claude -p でレビュー実施 ←── claude_runner.py
  ├─ Step 4: 判定結果に応じてDB更新
  │   ├─ APPROVED → タスク=COMPLETED
  │   ├─ REJECTED → タスク=REWORK
  │   └─ ESCALATED → タスク=ESCALATED
  └─ Step 5: REVIEWファイル作成
```

### オプション一覧

| オプション | 説明 |
|-----------|------|
| `--dry-run` | 実行計画のみ表示 |
| `--skip-ai` | AI処理をスキップ（自動承認） |
| `--auto-approve` | レビューなしで自動承認 |
| `--verbose` | 詳細ログ出力 |
| `--json` | JSON形式で出力 |
| `--timeout SEC` | タイムアウト秒数（デフォルト: 300） |
| `--model MODEL` | AIモデル（デフォルト: sonnet） |

---

**引数**:
- 第1引数: プロジェクト名（例: AI_PM_PJ）
- 第2引数: REPORT_ID または オプション
  - REPORT_ID: 通常タスク 3桁数字（例: 069）または割り込みタスク（例: 075_INT, 075_INT_02）
  - `--list`: レビューキュー一覧を表示
  - `--next`: 次の優先タスクを自動選択してレビュー開始
  - `--batch`: レビューキュー内のタスクを連続レビュー
  - `--all`: レビューキュー全体をサマリ表示後、まとめてレビュー

**引数解析**:
- `$ARGUMENTS` をスペースで分割
- 引数が1つのみで `--list` の場合: エラー「プロジェクト名を指定してください」
- 引数が2つで第2引数が `--list` の場合: レビューキュー一覧表示モード
- 引数が2つで第2引数が `--next` の場合: 次タスク自動選択モード
- 引数が2つで第2引数が `--batch` の場合: バッチレビューモード
- 引数が2つで第2引数が `--all` の場合: 全件レビューモード
- 引数が2つでREPORT_IDの場合: 従来の特定タスクレビューモード
- 引数が0または1つ（オプション以外）の場合: エラーメッセージ表示

---

## Step 0: データソース判定（DB中心アーキテクチャ対応）

各モード処理の前に、データ取得先を判定しDB優先でレビューキュー・タスク情報を取得します。

### 0.1 DB利用可能判定

以下の条件を順に確認：

```
DB利用可能判定:
1. backend/ ディレクトリが存在するか確認
2. data/aipm.db ファイルが存在するか確認
3. 両方存在 → DBモード
4. いずれか存在しない → 従来方式（Markdown直接読み込み）
```

### 0.2 DBモードでのデータ取得

DBが利用可能な場合、以下のスクリプトでレビューキュー情報を取得：

**タスク情報取得**:
```bash
# 特定タスクの情報取得
python backend/task/get.py $PROJECT_NAME $TASK_ID --json
```

### 0.3 フォールバック処理

DBスクリプト実行に失敗した場合、または DB が存在しない場合は従来方式にフォールバック：

```
フォールバック条件:
1. backend/ が存在しない
2. data/aipm.db が存在しない
3. DBスクリプトがエラーで終了（exit code != 0）
4. DBスクリプトの出力が空またはパースエラー

フォールバック時の動作:
→ エラーメッセージを表示しDBスクリプトの修復を促す
→ TASK_XXX.md / REPORT_XXX.md を Glob → Read で取得
```

### 0.4 データソースインジケータ表示（オプション）

データ取得元を表示する場合のフォーマット：

```
【データソース】
- モード: DB優先
- DB: ✓ (data/aipm.db)
- スクリプト: ✓ (backend/)
```

または（フォールバック時）:

```
【データソース】
- モード: Markdown直接読み込み
- 理由: DBスクリプトが利用不可
```

### 0.5 後方互換性対応表

| 機能 | DBモード | フォールバック（従来方式） |
|------|---------|-------------------------|
| タスク情報取得 | `task/get.py` | TASK_XXX.md を Glob → Read |
| タスクステータス更新 | `task/update.py` | エラー終了（DB必須） |
| BACKLOG更新 | `backlog/update.py` | エラー終了（DB必須） |

---

## オプションモード一覧

| オプション | モード名 | 説明 |
|-----------|---------|------|
| `--list` | 一覧表示 | レビューキューを一覧表示（レビュー実施なし） |
| `--next` | 次タスク自動選択 | 最優先の1タスクをレビュー |
| `--batch` | バッチレビュー | キュー内タスクを連続レビュー（1件ずつ判定） |
| `--all` | 全件レビュー | サマリ表示後、全タスクをまとめてレビュー |
| (REPORT_ID) | 個別レビュー | 指定タスクのみレビュー（従来動作） |

---

## --list: レビューキュー一覧表示

```
/aipm-review AI_PM_PJ --list
```

以下の手順を実行：

#### 1. レビュー待ちタスク取得（スクリプト呼び出し）

```bash
python backend/task/list.py $PROJECT_NAME --status DONE --json
```

**取得される情報**:
- ステータスがDONE（レビュー待ち）のタスクを抽出
- 優先度順（P0 > P1 > P2）＋ 提出日時順（FIFO）でソート

#### 3. 一覧表示
   ```
   【レビューキュー一覧】$PROJECT_NAME

   | # | Task ID | ORDER | 提出日時 | 優先度 | 待機時間 |
   |---|---------|-------|---------|--------|---------|
   | 1 | TASK_003 | ORDER_018 | 2026-01-16 10:00 | P0 (差戻) | 2時間 |
   | 2 | TASK_001 | ORDER_018 | 2026-01-16 09:00 | P1 | 3時間 |
   | 3 | TASK_002 | ORDER_018 | 2026-01-16 09:30 | P2 | 2.5時間 |

   レビュー待ち: 3件

   【アクション】
   - 特定タスクをレビュー: /aipm-review AI_PM_PJ 003
   - 最優先タスクをレビュー: /aipm-review AI_PM_PJ --next
   - 連続レビュー: /aipm-review AI_PM_PJ --batch
   - 全件一括レビュー: /aipm-review AI_PM_PJ --all
   ```

5. **キューが空の場合**
   ```
   【レビューキュー一覧】$PROJECT_NAME

   レビュー待ちタスクはありません。
   ```

---

### --next: 次タスク自動選択

```
/aipm-review AI_PM_PJ --next
```

以下の手順を実行：

#### 1. レビュー待ちタスクからの取得（スクリプト呼び出し）

```bash
python backend/task/list.py $PROJECT_NAME --status DONE --json
```

優先度順（P0 > P1 > P2）でソート済みのリストを取得。

#### 2. 最優先タスク選択

スクリプト出力の最初のエントリが最優先タスク。

#### 3. キューが空の場合

```
【レビューキュー】レビュー待ちタスクはありません。
```
→ 処理終了

#### 4. タスク選択時
   - 選択されたタスクでレビュー実行（下記「通常のレビューフロー」へ）
   - レビュー開始前にタスク情報を表示：
   ```
   【自動選択】最優先タスク: TASK_003 (P0, ORDER_018)

   レビューを開始します...
   ```

---

### --batch: バッチレビュー（連続レビュー）

```
/aipm-review AI_PM_PJ --batch
```

レビューキュー内のタスクを優先度順に**連続レビュー**します。各タスクごとに承認/差し戻しを判定し、全タスク完了まで繰り返します。

#### バッチレビューフロー

1. **レビューキューサマリ表示**
   - レビューキューを読み込み、サマリを表示（後述の「レビューキューサマリ」参照）
   - キューが空の場合は終了

2. **確認プロンプト**
   ```
   【バッチレビュー開始】
   レビュー待ち: X件（P0: Y件, P1: Z件）

   連続レビューを開始しますか？ [Y/n]
   ```
   - `n` の場合: 処理終了
   - `Y` の場合: 連続レビュー開始

3. **連続レビュー実行**（**各タスクでDB更新必須**）
   ```
   繰り返し（キューが空になるまで）:
     a. 最優先タスクを選択（P0 > P1 > P2 > 提出順）
     b. タスク開始通知表示
        【レビュー中】(1/X) TASK_XXX - {タスク名}
     c. 「通常のレビューフロー」（Step 1〜9）を**完全に実行**
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        【必須】Step 7（DB更新）を**必ず**実行すること
        ・承認時: task/update.py → COMPLETED
          → タスクステータス: DONE → COMPLETED
        ・差し戻し時: task/update.py → REWORK
          → タスクステータス: DONE → REWORK
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     d. DB更新確認（各タスク完了時）
        - 更新成功: 「DB更新完了: TASK_XXX → COMPLETED/REWORK」
        - 更新失敗: エラー表示、バッチを一時停止
     e. 結果表示
        → 承認 / 差し戻し / エスカレーション
     f. 次タスクへ継続確認（オプション）
        続行しますか？ [Y/n/skip]
        - Y: 次タスクへ
        - n: バッチ終了
        - skip: 現タスクをスキップして次へ
   ```

4. **バッチ完了サマリ**（DB更新状況含む）
   ```
   【バッチレビュー完了】

   ■ レビュー結果
   | 結果 | 件数 |
   |------|------|
   | 承認 | X件 |
   | 差し戻し | Y件 |
   | スキップ | Z件 |

   ■ DB更新状況
   | 項目 | 件数 |
   |------|------|
   | COMPLETED更新成功 | X件 |
   | REWORK更新成功 | Y件 |
   | 更新失敗 | 0件 |

   ■ タスク別詳細
   | Task ID | レビュー結果 | DB更新 |
   |---------|-------------|--------|
   | TASK_XXX | 承認 | COMPLETED ✓ |
   | TASK_YYY | 差し戻し | REWORK ✓ |

   残りレビュー待ち: N件

   【次のアクション】
   - 残タスクをレビュー: /aipm-review AI_PM_PJ --batch
   - Worker実行: /aipm-worker AI_PM_PJ XXX
   ```

#### バッチレビューのオプション動作

| 動作 | 説明 |
|------|------|
| 継続確認あり（デフォルト） | 各タスク後に継続確認を表示 |
| 差し戻し時 | タスクはREWORK状態に、キューにREJECTEDで残る |
| エスカレーション時 | バッチを一時停止、User判断後に再開可能 |
| 中断時 | 処理済みタスクの結果は保持、残りはキューに残る |

---

### --all: 全件レビュー（サマリ＋一括レビュー）

```
/aipm-review AI_PM_PJ --all
```

レビューキュー全体を**サマリ表示**した後、**まとめてレビュー**します。全タスクの概要を把握してから判定を行うモードです。

#### 全件レビューフロー

1. **レビューキューサマリ表示**
   - キュー全体の詳細サマリを表示（「レビューキューサマリ」参照）

2. **全タスク概要一覧**
   ```
   【レビュー対象タスク一覧】

   ## TASK_167 - aipm-worker.md 完了サマリ出力強化
   - Worker: Worker A
   - 完了日: 2026-01-20
   - 主要成果物: DEV/.claude/commands/aipm-worker.md
   - 完了サマリ: Step 6.5新設、DB更新ロジック追加
   - 完了条件: 4/4 チェック済み

   ## TASK_168 - aipm-review.md 一括レビュー機能追加
   - Worker: Worker A
   - 完了日: 2026-01-20
   - 主要成果物: DEV/.claude/commands/aipm-review.md
   - 完了サマリ: --batch/--allオプション追加
   - 完了条件: 4/4 チェック済み

   ---
   合計: 2件
   ```

3. **一括処理選択**
   ```
   【一括レビューオプション】

   A. 全件順次レビュー
      → 各タスクを順番にレビュー（--batchと同様）

   B. 一括承認（条件付き）
      → 全タスクの完了条件が満たされている場合のみ選択可能
      → エスカレーション・問題なしの場合に使用

   C. 個別選択
      → 特定タスクのみレビュー、残りは保留

   D. キャンセル
      → レビューを実施せず終了

   選択してください [A/B/C/D]:
   ```

4. **選択肢に応じた処理**

   **A. 全件順次レビュー**:
   - --batch と同様のフローで順次レビュー

   **B. 一括承認**（条件付き）:
   - 事前チェック:
     - 全タスクの完了条件が全てチェック済み
     - エスカレーション事項がない
     - 重大な問題がない
   - 条件を満たす場合のみ選択可能
   - 一括で全タスクを承認
   - **各タスクについて DB を更新**:
     - タスクステータス: DONE → COMPLETED
     - レビューキュー: 各タスクを削除
     - 進捗サマリ: 完了タスク数を更新
   - REVIEWファイル作成
   ```
   【一括承認実行】

   以下のタスクを一括承認します：
   - TASK_167: aipm-worker.md 完了サマリ出力強化
   - TASK_168: aipm-review.md 一括レビュー機能追加

   実行しますか？ [Y/n]
   ```

   **C. 個別選択**:
   ```
   レビューするタスクを選択（カンマ区切り）: 167,168
   → 選択タスクのみ順次レビュー
   ```

   **D. キャンセル**:
   ```
   【キャンセル】レビューを中止しました。
   ```

5. **全件レビュー完了サマリ**
   ```
   【全件レビュー完了】

   | Task ID | タスク名 | 結果 |
   |---------|---------|------|
   | TASK_167 | aipm-worker.md 完了サマリ出力強化 | 承認 |
   | TASK_168 | aipm-review.md 一括レビュー機能追加 | 承認 |

   承認: 2件 / 差し戻し: 0件

   【次のアクション】
   - 次のタスク実行: /aipm-worker AI_PM_PJ XXX
   - プロジェクト状態確認: /aipm-status AI_PM_PJ
   ```

---

## レビューキューサマリ

`--batch`、`--all` で使用するサマリ表示形式です。

### サマリ表示内容

```
【レビューキューサマリ】$PROJECT_NAME

## 概要
- レビュー待ち: X件
- P0（差戻）: Y件
- P1（通常）: Z件
- 最長待機: N時間（TASK_XXX）

## タスク一覧

| # | Task ID | タスク名 | Worker | 提出日時 | 優先度 | 待機 |
|---|---------|---------|--------|---------|--------|------|
| 1 | TASK_003 | 〇〇機能実装 | Worker A | 01-16 10:00 | P0 | 2h |
| 2 | TASK_001 | △△修正 | Worker B | 01-16 09:00 | P1 | 3h |

## Worker完了サマリ（各タスク）

### TASK_003
- 実施内容: 〇〇機能を実装、△△を修正
- 主要成果物: src/xxx.ts, docs/yyy.md
- 判断ポイント: □□の理由で◇◇を採用
- 未解決課題: なし

### TASK_001
- 実施内容: △△のバグを修正
- 主要成果物: src/aaa.ts
- 判断ポイント: 後方互換性を考慮し既存APIを維持
- 未解決課題: パフォーマンス改善は別タスクで対応
```

### サマリ情報の取得元

| 情報 | 取得元 |
|------|--------|
| タスク名 | TASK_XXX.md |
| Worker | DB タスク一覧 |
| 提出日時 | DB レビューキュー |
| 完了サマリ | REPORT_XXX.md「完了サマリ」セクション |
| 完了条件チェック | REPORT_XXX.md「完了条件チェック」セクション |

---

## 通常のレビューフロー

以下の手順を実行してください：

### 1. REPORT読み込み
- `Glob` を使用してREPORTファイルを検索
  - path: `PROJECTS/$PROJECT_NAME/RESULT`
  - pattern: `**/REPORT_$REPORT_ID.md`
- 複数候補がある場合は最新のORDER（ORDER番号が最大）を選択
- REPORTファイルが見つからない場合: 「エラー: REPORT_$REPORT_ID.md が見つかりません。」を表示

### 2. TASK読み込み
- REPORT読み込みで取得したファイルパスからORDERディレクトリを特定
- 対応する `TASK_$REPORT_ID.md` を同じORDERディレクトリの `04_QUEUE/TASK_$REPORT_ID.md` から読み込む

### 3. レビュー実施
- 完了条件がすべて達成されているか確認
- 成果物の品質確認
- エスカレーション事項の確認

### 5. レビュー結果判定

レビュー結果は以下の3つから選択します：

- **承認（OK）**: すべての完了条件を満たし、品質に問題がない
- **差し戻し（NG）**: 完了条件未達または品質に問題あり
- **エスカレーション（ESC）**: Userの判断が必要

#### 5.1 レビュー判定基準

##### 承認（OK）基準

以下の**すべて**を満たす場合に承認：

| 基準 | チェック内容 |
|------|------------|
| 完了条件達成 | TASK定義の完了条件が全てチェック済み |
| 成果物要件 | 成果物が要件を満たしている |
| 品質基準 | コード/ドキュメントの品質が基準を満たしている |
| テスト実施 | テストが実施され、問題がない（該当する場合） |
| 副作用なし | 既存機能への悪影響がない |

##### 承認（OK）基準（バグ修正タスクの追加条件）

バグ修正タスクの場合、上記の基準に加えて以下もチェック：

| 基準 | チェック内容 |
|------|------------|
| 横展開確認済み | REPORTに「横展開チェック結果」セクションが記載されている |
| 横展開対応済み | 類似箇所の修正漏れがない（横展開リスト参照） |
| 検索実施済み | 類似パターンの検索コマンドと結果が記載されている |

**確認ポイント**:
- 横展開チェック結果セクションが存在するか
- 検索コマンドが実行されているか
- 横展開リストが作成されているか
- 「同様の問題あり」の箇所がすべて対応済みか
- 省略の場合、妥当な理由が記載されているか

**省略が許容されるケース**:
- 新規機能追加タスク（「新規機能のため横展開対象なし」）
- ドキュメント修正のみ（「ドキュメント修正のため横展開対象なし」）
- 一意な処理の修正（「検索の結果、類似パターンなし」）

##### 差し戻し（NG）基準

以下の**いずれか**に該当する場合は差し戻し：

| 基準 | 判定内容 |
|------|---------|
| 完了条件未達 | 完了条件の未チェック項目がある |
| 成果物不備 | 成果物が要件を満たしていない |
| 品質問題 | コード品質/可読性/保守性に問題がある |
| バグあり | 重大なバグや不具合がある |
| テスト不足 | 必要なテストが実施されていない |
| 仕様不一致 | 仕様と実装が一致しない |

##### エスカレーション（ESC）基準

以下の**いずれか**に該当する場合はエスカレーション：

| 基準 | 判定内容 |
|------|---------|
| 要件曖昧 | 要件の解釈に曖昧さがあり、PM判断では決定不可 |
| 技術判断 | 技術的判断でUser確認が必要 |
| 想定外状況 | 想定外の状況が発生し、方針決定が必要 |
| 方針選択 | 複数の実装方針があり、User選択が必要 |
| スコープ変更 | タスクスコープの変更が必要な場合 |

#### 5.2 差し戻し理由カテゴリ

差し戻し時は以下のカテゴリから理由を選択し、具体的な修正指針を提示します：

| カテゴリ | コード | 説明 | 修正指針の記載内容 |
|---------|-------|------|-----------------|
| 完了条件未達 | `INCOMPLETE` | 完了条件の一部が未達 | 未達項目を明示、対応方法を提示 |
| 品質基準未達 | `QUALITY` | コード/ドキュメントの品質問題 | 具体的な品質問題を指摘、改善例を提示 |
| バグ・不具合 | `BUG` | 機能的なバグや不具合 | 再現手順と期待動作を明示 |
| 仕様不一致 | `SPEC_MISMATCH` | 仕様と実装の乖離 | 正しい仕様を明示、該当箇所を指摘 |
| テスト不足 | `MISSING_TEST` | テストケース不足 | 必要なテストケースを提示 |
| ドキュメント問題 | `DOC_ISSUE` | ドキュメントの不備・誤り | 修正すべき箇所を明示 |
| 横展開漏れ | `LATERAL_MISSING` | バグ修正時の類似箇所の修正漏れ | 未対応箇所を明示、検索コマンド例を提示 |

##### 差し戻しコメントのフォーマット

```
【差し戻し】TASK_XXX

カテゴリ: {INCOMPLETE|QUALITY|BUG|SPEC_MISMATCH|MISSING_TEST|DOC_ISSUE|LATERAL_MISSING}

■ 問題点
- {具体的な問題の説明}

■ 修正指針
- {修正方法の具体的な指示}

■ 参照
- {関連する仕様や要件への参照}
```

##### 差し戻しコメント例（横展開漏れの場合）

```
【差し戻し】TASK_200

カテゴリ: LATERAL_MISSING

■ 問題点
- order_exists() の複合キー対応を修正したが、横展開チェックが不十分
- backlog_exists() に同様の問題が残存している

■ 修正指針
- 以下のコマンドで類似関数を再検索してください：
  grep -r "def .*_exists" backend/
- backlog_exists() も複合キー対応に修正してください
- 横展開リストを更新し、全箇所の対応状況を記載してください

■ 参照
- aipm-worker.md Step 3.1: バグ修正時の横展開チェック
- BACKLOG_066: backlog_exists()の修正漏れ（類似事例）
```

##### 差し戻し優先度

差し戻しタスクはレビューキューに優先度P0で再登録されます：

| 状況 | 優先度 |
|------|--------|
| 初回差し戻し | P0 |
| 2回目以降の差し戻し | P0 + エスカレーション検討 |

**2回以上の差し戻しが発生した場合**:
- 根本原因の分析を実施
- 要件定義の曖昧さ、スキルギャップ、タスク分割の問題を検討
- 必要に応じてエスカレーション

### 6. REVIEW作成
- `PROJECTS/$PROJECT_NAME/RESULT/ORDER_XXX/07_REVIEW/REVIEW_$REPORT_ID.md` を作成
- レビュー結果、承認/差し戻し理由、改善提案を記載

### 7. DB更新（タスクステータス）

レビュー結果に応じてデータベースを更新。スクリプト呼び出しでタスクステータスを更新。

#### 7.1 レビュー結果とスクリプトの対応

| レビュー結果 | スクリプト呼び出し | タスクステータス |
|-------------|------------------|----------------|
| 承認（OK） | `python backend/task/update.py $PROJECT_NAME $TASK_ID --status COMPLETED --reviewed-at now` | COMPLETED |
| 差し戻し（NG） | `python backend/task/update.py $PROJECT_NAME $TASK_ID --status REWORK --reviewed-at now` | REWORK |
| エスカレーション（ESC） | `python backend/task/update.py $PROJECT_NAME $TASK_ID --status ESCALATED` | ESCALATED |

#### 7.2 承認時のスクリプト実行

```bash
python backend/task/update.py $PROJECT_NAME $TASK_ID --status COMPLETED --reviewed-at now --json
```

**成功時の出力例**:
```json
{
  "success": true,
  "task_id": "TASK_188",
  "old_task_status": "DONE",
  "new_task_status": "COMPLETED",
  "message": "タスクステータスを更新しました: DONE → COMPLETED"
}
```

**スクリプトが自動実行する処理**:
- タスクステータス: DONE → COMPLETED
- reviewed_at の記録
- 完了日時の記録
- 状態遷移履歴の記録

#### 7.3 差し戻し時のスクリプト実行

```bash
python backend/task/update.py $PROJECT_NAME $TASK_ID --status REWORK --reviewed-at now --json
```

**成功時の出力例**:
```json
{
  "success": true,
  "task_id": "TASK_188",
  "old_task_status": "DONE",
  "new_task_status": "REWORK",
  "message": "タスクステータスを更新しました: DONE → REWORK"
}
```

**スクリプトが自動実行する処理**:
- タスクステータス: DONE → REWORK
- reviewed_at の記録
- 差し戻しコメントの記録
- 状態遷移履歴の記録

#### 7.4 Markdown自動生成

DB更新後、以下が自動更新されます：
- タスク一覧のステータス
- 進捗サマリ（完了タスク数、レビュー待ちタスク数）

#### 7.5 後方互換性

DBが存在しない場合はエラー終了：
- DBスクリプトの修復が必要
- 処理を中断

### 8. ORDER完了時処理（承認時のみ）

承認（OK）判定でORDER内の**全タスクが完了**した場合、以下の処理を実行します。

#### 8.1 ORDER完了判定

DBから全タスクのステータスを確認：

```bash
python backend/task/list.py $PROJECT_NAME --order $ORDER_ID --json
```

**ORDER完了条件**: 全タスクが `COMPLETED` である

ORDER未完了の場合は、このステップ全体をスキップ。

#### 8.2 関連BACKLOG検出

DBから関連BACKLOGを取得：

```bash
python backend/backlog/list.py $PROJECT_NAME --order-id $ORDER_ID --json
```

または、DBのordersテーブルから`related_backlog_id`フィールドを参照。

#### 8.3 スキップ条件

以下の場合はBACKLOG更新をスキップ（エラーにしない）：

| 条件 | 処理 |
|------|------|
| 関連BACKLOGが検出されない | スキップ（メッセージなし） |
| BACKLOGが既にDONE | スキップ（メッセージなし） |
| BACKLOGが既にCANCELED | スキップ（メッセージなし） |
| ORDER内に未完了タスクあり | スキップ（メッセージなし） |

#### 8.4 BACKLOG更新処理（スクリプト呼び出し）

スキップ条件に該当しない場合、以下のスクリプトを実行：

```bash
python backend/backlog/update.py $PROJECT_NAME $BACKLOG_ID --status DONE --json
```

**成功時の出力例**:
```json
{
  "success": true,
  "backlog_id": "BACKLOG_029",
  "old_status": "IN_PROGRESS",
  "new_status": "DONE",
  "message": "BACKLOGを更新しました: BACKLOG_029"
}
```

**スクリプトが自動実行する処理**:
- ステータス更新: IN_PROGRESS → DONE
- 完了日時の記録
- 状態遷移履歴の記録

#### 8.5 完了メッセージへの追記

BACKLOG更新を実行した場合、最終回答のメッセージに以下を追記：

```
BACKLOG更新: BACKLOG_XXX → DONE（ORDER完了）
```

#### 8.6 リリース必要性の判定（ORDER完了時のみ）

ORDER完了時、成果物にリリース対象ファイルが含まれるかを判定します。

**リリース対象パス**:
| パスパターン | 説明 |
|------------|------|
| `.claude/commands/` | コマンドファイル |
| `scripts/` | スクリプトファイル |
| `TEMPLATE/` | テンプレートファイル |

**判定ロジック**:
```
リリース必要性判定:
1. ORDER内の全REPORTを確認
2. 各REPORTの「成果物」セクションからファイルパスを抽出
3. 以下のパターンに該当するか確認:
   - DEV/.claude/commands/ を含む
   - DEV/scripts/ を含む
   - DEV/TEMPLATE/ を含む
4. 1つでも該当 → リリース必要
5. 該当なし → リリース不要（案内をスキップ）
```

**プロジェクト別の追加条件**:
| プロジェクト | 追加リリース条件 | リリース手順 |
|-------------|----------------|-------------|
| ai_pm_manager | Electronアプリの変更あり | `npm run make` → Setup.exe実行 |
| AI_PM_PJ | フレームワーク本体の変更 | `/aipm-release-review` で承認フロー |

#### 8.8 リリース案内の表示

リリースが必要と判定された場合、以下の案内を表示：

```
【リリース必要】ORDER_XXX 完了

このORDERにはリリースが必要な成果物が含まれています：
- DEV/.claude/commands/aipm-review.md

【リリース手順】
1. 成果物をDEV環境から本番環境にコピー
2. リリースレビューを実施: /aipm-release-review
3. 承認後、バージョンタグを付与

リリースを実施しますか？ [Y/n/later]
- Y: リリース手順を開始
- n: リリースせずに終了（警告を表示）
- later: リリースを保留（未リリースORDERとして記録）
```

**選択肢の処理**:

| 選択 | 処理 |
|------|------|
| Y | リリース手順の案内を表示し、`/aipm-release-review`を促す |
| n | 「警告: リリースが未完了です。後で実施してください。」を表示 |
| later | DBに「未リリースORDER」として記録（将来実装） |

#### 8.9 リリース不要時のスキップ

以下の場合はリリース案内をスキップ：
- リリース対象パスに該当するファイルがない
- ドキュメントのみの変更（RESULT/配下のみ）
- 調査・分析タスクのみのORDER

---

### 9. 最終回答

レビュー結果を要約して表示:

```
【レビュー結果】TASK_XXX: 承認/差し戻し/エスカレーション

REVIEW_XXX.md を作成しました。
パス: PROJECTS/$PROJECT_NAME/RESULT/ORDER_XXX/07_REVIEW/REVIEW_$REPORT_ID.md

タスクステータス更新: TASK_XXX → COMPLETED/REWORK
BACKLOG更新: BACKLOG_XXX → DONE（ORDER完了）    ← 該当時のみ表示

【次のアクション】
- 承認の場合: 次のタスクを提示
  - レビューキューに残タスクあり: 「次のレビュー: /aipm-review $PROJECT_NAME --next」
  - 新規タスク実行可能: 「Worker実行: /aipm-worker $PROJECT_NAME XXX」
- 差し戻しの場合: 修正が必要な項目を明示
  - 「Workerが修正後に再提出します。差し戻しタスクは優先度P0で再キューイングされます。」
- エスカレーションの場合: Userへの質問事項を明示
```

#### 9.1 ORDER完了時のリリース案内（承認かつORDER完了時のみ）

ORDER内の全タスクが完了し、リリース対象ファイルがある場合は以下を追加表示：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【ORDER完了】ORDER_XXX - {ORDER名}

🎉 全タスクが完了しました！

【リリース対象ファイル】
- .claude/commands/aipm-review.md

【次のステップ: リリース実行】
リリースを実施してください:
/aipm-release-review

※ リリースを完了するまでORDERは正式完了とみなされません。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**リリース対象がない場合**（ドキュメントのみ等）:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【ORDER完了】ORDER_XXX - {ORDER名}

🎉 全タスクが完了しました！

このORDERはリリース対象ファイルを含まないため、
リリース手順は不要です。

【次のアクション】
- プロジェクト状態確認: /aipm-status $PROJECT_NAME
- 次のORDER開始: /aipm-pm $PROJECT_NAME
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 実行例

### 1. レビューキュー一覧表示
```
/aipm-review AI_PM_PJ --list
```
→ AI_PM_PJ プロジェクトのレビューキュー一覧を優先度順に表示

### 2. 次タスク自動選択レビュー
```
/aipm-review AI_PM_PJ --next
```
→ 最優先のレビュー待ちタスクを自動選択してレビュー開始

### 3. 通常タスクのレビュー
```
/aipm-review AI_PM_PJ 069
```
→ AI_PM_PJ プロジェクトの REPORT_069.md をレビューし、REVIEW_069.md を作成

### 4. 割り込みタスクのレビュー
```
/aipm-review AI_PM_PJ 075_INT
```
→ AI_PM_PJ プロジェクトの REPORT_075_INT.md をレビューし、REVIEW_075_INT.md を作成

### 5. 複数回割り込みタスクのレビュー
```
/aipm-review AI_PM_PJ 075_INT_02
```
→ AI_PM_PJ プロジェクトの REPORT_075_INT_02.md をレビューし、REVIEW_075_INT_02.md を作成

### 6. ORDER完了時のBACKLOG自動更新とリリース案内
```
/aipm-review AI_PM_PJ 134
```
→ TASK_134がORDER_028の最後のタスクで、承認（OK）判定の場合
→ BACKLOG_009（関連BACKLOG）を自動的に `IN_PROGRESS` → `DONE` に更新
→ 完了メッセージに「BACKLOG更新: BACKLOG_009 → DONE」を表示
→ リリース対象ファイルがある場合、リリース案内を表示:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   【ORDER完了】ORDER_028 - リリース漏れ防止機能追加

   🎉 全タスクが完了しました！

   【リリース対象ファイル】
   - .claude/commands/aipm-review.md

   【次のステップ: リリース実行】
   リリースを実施してください:
   /aipm-release-review
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ```

### 7. バッチレビュー（連続レビュー）
```
/aipm-review AI_PM_PJ --batch
```
→ レビューキュー内のタスクを優先度順に連続レビュー
→ 各タスクごとに承認/差し戻しを判定
→ 全タスク完了後にサマリ表示

### 8. 全件レビュー（サマリ＋一括）
```
/aipm-review AI_PM_PJ --all
```
→ レビューキュー全体のサマリを表示
→ 全タスクの概要（Worker完了サマリ含む）を一覧
→ 一括承認 or 順次レビュー or 個別選択を選択
→ 全完了条件チェック済みの場合は一括承認オプション利用可能

---

## 後方互換性

### DBにレビューキューがない場合

- レビューキュー更新処理をスキップ
- 従来のタスクステータス更新のみ実施
- 警告・エラーは出さない

### レビューキュー導入前のプロジェクト

| 項目 | 動作 |
|------|------|
| --list | 「レビューキューが設定されていません」と表示 |
| --next | 「レビューキューが設定されていません」と表示 |
| --batch | 「レビューキューが設定されていません」と表示 |
| --all | 「レビューキューが設定されていません」と表示 |
| 特定タスク指定 | 従来通りレビュー実行可能 |

### Worker完了サマリがない場合

- `--batch`、`--all` でWorker完了サマリセクションが表示されない
- レビュー自体は従来通り実行可能
- REPORT_XXX.md の「完了条件チェック」セクションで判定

---

## エラー処理

| エラー | メッセージ |
|--------|----------|
| プロジェクト名なし | 「エラー: プロジェクト名を指定してください。使い方: /aipm-review PROJECT_NAME [REPORT_ID\|--list\|--next\|--batch\|--all]」 |
| REPORT_IDなし（オプションなし） | 「エラー: REPORT_IDまたはオプション(--list, --next, --batch, --all)を指定してください。」 |
| REPORTファイル未発見 | 「エラー: REPORT_$REPORT_ID.md が見つかりません。」 |
| キュー空で--next/--batch/--all | 「レビュー待ちタスクはありません。」（エラーではなく情報） |
| 一括承認条件未達 | 「一括承認の条件を満たしていません。順次レビューを選択してください。」 |

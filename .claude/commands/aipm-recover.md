---
description: 中断タスクの状態確認とリカバリ - /aipm-recover PROJECT_NAME [TASK_ID]
---

中断タスクの状態確認と再開を行うリカバリコマンドです。

**引数**:
- 第1引数: プロジェクト名（例: AI_PM_PJ）
- 第2引数（任意）: TASK_ID（例: 178）
  - 省略時: 全中断タスク一覧を表示
  - 指定時: 該当タスクのリカバリ処理を実行

以下の手順を実行してください：

---

## 1. 引数解析

引数を解析し、動作モードを決定します。

```
引数解析ロジック:
1. 引数が0個の場合:
   → エラー: 「プロジェクト名を指定してください。使い方: /aipm-recover PROJECT_NAME [TASK_ID]」
2. 引数が1個の場合:
   → PROJECT_NAME = 第1引数
   → 動作モード = 一覧表示モード
3. 引数が2個の場合:
   → PROJECT_NAME = 第1引数
   → TASK_ID = 第2引数
   → 動作モード = リカバリ実行モード
```

---

## 2. 中断タスク検索（DB中心アーキテクチャ対応）

DBからINTERRUPTEDステータスのタスクを検索します。

### 2.1 DBモードでの中断タスク検索

DBが利用可能な場合、以下のスクリプトで中断タスクを取得します。

**スクリプト呼び出し**:

```bash
# INTERRUPTEDタスク一覧を取得
cd scripts/aipm-db && python -m task.list $PROJECT_NAME --status INTERRUPTED --json
```

**取得できる情報**:
- タスクID、タスク名
- 担当Worker
- 開始日、中断日時
- ORDER ID

### 2.2 フォールバック処理（DB利用不可時）

DBスクリプトが利用できない場合、エラーを表示しDBスクリプトの修復を促します。

```
フォールバック処理:
1. 「エラー: DBスクリプトが利用できません。修復してください。」を表示
2. 初期化手順を案内
```

### 2.3 中断タスク検索ロジック

```
中断タスク検索ロジック:
1. DBからステータス=INTERRUPTEDのタスクを取得
2. 各タスクについて以下を取得:
   - Task ID
   - タスク名
   - 担当Worker
   - 開始日
```

### 2.3 中断タスクなしの場合

```
【中断タスク状況】プロジェクト: $PROJECT_NAME

中断中のタスクはありません。

【現在の状況】
- 実行中タスク: {IN_PROGRESSタスク一覧}
- 待機中タスク: {QUEUEDタスク一覧}

タスクを開始するには:
/aipm-worker $PROJECT_NAME {TASK_ID}
```

---

## 3. 一覧表示モード（TASK_ID省略時）

中断タスクが存在する場合、一覧を表示します。

### 3.1 チェックポイント情報取得（DB経由）

各中断タスクについてDBからチェックポイント情報を取得します。

```
チェックポイント取得ロジック:
1. DBからタスクの状態遷移履歴を取得
2. チェックポイント情報が取得できた場合:
   - 最新のチェックポイント情報を表示
   - エラーログ情報を表示（存在する場合）
3. チェックポイント情報がない場合:
   - チェックポイント情報: 「情報なし」
```

### 3.2 中断タスク一覧表示

```
【中断タスク一覧】プロジェクト: $PROJECT_NAME

| Task ID | タスク名 | 最終チェックポイント | 中断日時 | 次のアクション |
|---------|---------|---------------------|---------|---------------|
| TASK_XXX | XXX機能実装 | Step 3完了 | 2026-01-21 14:30 | 次ステップ実行 |
| TASK_YYY | YYY調査 | 調査開始 | 2026-01-21 10:00 | 資料読み込み |

【リカバリ方法】
特定のタスクをリカバリするには:
/aipm-recover $PROJECT_NAME {TASK_ID}

例:
/aipm-recover $PROJECT_NAME XXX
```

### 3.3 チェックポイント詳細表示

各タスクのチェックポイント履歴を詳細表示します。

```
【チェックポイント詳細】TASK_XXX

最新チェックポイント:
- ステップ: Step 3完了
- 時刻: 2026-01-21 14:30
- 次のアクション: 次ステップ実行
- メモ: 設計書v1.0作成済み

チェックポイント履歴（直近5件）:
| 時刻 | ステップ | 次のアクション | メモ |
|------|---------|---------------|------|
| 2026-01-21 14:30 | Step 3完了 | 次ステップ実行 | 設計書v1.0 |
| 2026-01-21 14:00 | Step 2完了 | Step 3実行 | 要件確認済み |
| 2026-01-21 13:30 | Step 1完了 | Step 2実行 | 着手 |

エラーログ:
| 発生日時 | 種別 | ステップ | メッセージ |
|---------|------|---------|----------|
| 2026-01-21 14:35 | SESSION_DISCONNECT | Step 3実行中 | ネットワーク切断 |
```

---

## 4. リカバリ実行モード（TASK_ID指定時）

指定されたタスクのリカバリ処理を実行します。

### 4.1 タスク存在確認（DBクエリ）

**スクリプト呼び出し**:

```bash
# タスク情報を取得
cd scripts/aipm-db && python -m task.get $PROJECT_NAME TASK_$TASK_ID --json
```

```
タスク確認ロジック:
1. DBでTASK_{TASK_ID}を検索
2. 見つからない場合:
   → エラー: 「TASK_{TASK_ID}が見つかりません。」
3. ステータスがINTERRUPTEDでない場合:
   → エラー: 「TASK_{TASK_ID}は中断状態ではありません（現在: {ステータス}）。」
```

### 4.2 リカバリ情報表示

```
【リカバリ対象】TASK_{TASK_ID}: {タスク名}

【最終チェックポイント】
- ステップ: {最終ステップ名}
- 時刻: {チェックポイント時刻}
- 次のアクション: {次のアクション}
- メモ: {メモ内容}

【エラー情報】（存在する場合）
- 発生日時: {エラー発生日時}
- 種別: {エラー種別}
- ステップ: {エラー発生時のステップ}
- メッセージ: {エラーメッセージ}

【選択肢】
A. 最終チェックポイントから再開（推奨）
   → 「{次のアクション}」から作業を継続
   → ステータス: INTERRUPTED → IN_PROGRESS
B. タスクをやり直し
   → 進捗をリセットして最初から実行
   → ステータス: INTERRUPTED → QUEUED
   → チェックポイント情報をクリア
C. タスクをキャンセル
   → タスクを完全に中止
   → ステータス: INTERRUPTED → CANCELLED

どのオプションを選択しますか？ [A/B/C]
```

### 4.3 オプションA: 最終チェックポイントから再開

**スクリプト呼び出し**:

```bash
# タスクステータスをIN_PROGRESSに更新
cd scripts/aipm-db && python -m task.update $PROJECT_NAME TASK_$TASK_ID \
  --status IN_PROGRESS \
  --assignee "{Worker識別子}" \
  --role Worker
```

```
再開処理:
1. DBタスク更新:
   - ステータス: INTERRUPTED → IN_PROGRESS
   - 担当: 現在のWorker識別子
   - 更新履歴に「リカバリ再開」を記録

完了メッセージ:
【リカバリ完了】TASK_{TASK_ID}を再開しました。

最終チェックポイント: {ステップ名}
次のアクション: {次のアクション}

作業を継続してください:
/aipm-worker $PROJECT_NAME {TASK_ID}
```

### 4.4 オプションB: タスクをやり直し

**スクリプト呼び出し**:

```bash
# タスクステータスをQUEUEDに戻す
cd scripts/aipm-db && python -m task.update $PROJECT_NAME TASK_$TASK_ID \
  --status QUEUED \
  --assignee "" \
  --role Worker
```

```
やり直し処理:
1. DBタスク更新:
   - ステータス: INTERRUPTED → QUEUED
   - 担当: 未割当に戻す
   - 開始日: クリア
   - チェックポイント情報をクリア
   - エラーログは保持（参考情報として）

完了メッセージ:
【やり直し完了】TASK_{TASK_ID}をQUEUEDに戻しました。

チェックポイントをクリアしました。
タスクを最初から実行できます:
/aipm-worker $PROJECT_NAME {TASK_ID}
```

### 4.5 オプションC: タスクをキャンセル

**スクリプト呼び出し**:

```bash
# タスクステータスをCANCELLEDに更新
cd scripts/aipm-db && python -m task.update $PROJECT_NAME TASK_$TASK_ID \
  --status CANCELLED \
  --role Worker
```

```
キャンセル処理:
1. 確認プロンプト:
   「タスクをキャンセルすると、進捗は失われます。本当にキャンセルしますか？ [y/N]」
2. y選択時:
   - DBタスク更新:
     - ステータス: INTERRUPTED → CANCELLED
     - 完了日: 現在日付（キャンセル日として）
3. N選択時:
   - 「キャンセルを中止しました。」と表示し終了

完了メッセージ:
【キャンセル完了】TASK_{TASK_ID}をキャンセルしました。

必要に応じて、新しいタスクを発行してください。
```

---

## 5. タスク更新ロジック（DB中心アーキテクチャ）

### 5.1 DBスクリプト経由での更新

タスクステータスの更新はすべてDBスクリプト経由で行います。

**基本的なスクリプト呼び出し**:

```bash
# タスクステータス更新
cd scripts/aipm-db && python -m task.update $PROJECT_NAME TASK_$TASK_ID \
  --status {新ステータス} \
  --assignee "{担当者}" \
  --role Worker
```

### 5.2 利用可能なオプション

| オプション | 説明 | 例 |
|-----------|------|-----|
| `--status` | ステータス変更 | IN_PROGRESS, QUEUED, CANCELLED |
| `--assignee` | 担当者変更 | "Worker A", "" |
| `--role` | 実行者ロール | Worker, PM |

### 5.3 フォールバック処理

DBスクリプトが利用できない場合、エラーを表示しDBスクリプトの修復を促します。

---

## 7. エラーハンドリング

### 7.1 一般的なエラー

| エラー条件 | メッセージ | 対応 |
|-----------|----------|------|
| プロジェクト名なし | 「プロジェクト名を指定してください」 | 使い方を表示 |
| DB接続失敗 | 「DBに接続できません」 | プロジェクト名を確認、DBスクリプトの修復を案内 |
| TASK_ID不正 | 「TASK_{ID}が見つかりません」 | 正しいIDを指定 |
| ステータス不一致 | 「中断状態ではありません」 | 現在のステータスを表示 |

### 7.2 リカバリ失敗時

```
リカバリ失敗時:
1. エラーメッセージを表示
2. DBロールバック機能を使用（利用可能な場合）
3. 「手動でステータスを確認してください」と案内
```

---

## 表示例

### 一覧表示モード

```
/aipm-recover AI_PM_PJ

【中断タスク一覧】プロジェクト: AI_PM_PJ

| Task ID | タスク名 | 最終チェックポイント | 中断日時 | 次のアクション |
|---------|---------|---------------------|---------|---------------|
| TASK_178 | チェックポイント記録追加 | 設計完了 | 2026-01-21 14:30 | 実装開始 |

【チェックポイント詳細】TASK_178

最新チェックポイント:
- ステップ: 設計完了
- 時刻: 2026-01-21 14:30
- 次のアクション: 実装開始
- メモ: aipm-worker.md編集箇所特定済み

チェックポイント履歴（直近5件）:
| 時刻 | ステップ | 次のアクション | メモ |
|------|---------|---------------|------|
| 2026-01-21 14:30 | 設計完了 | 実装開始 | 編集箇所特定済み |
| 2026-01-21 14:00 | 要件確認完了 | 設計開始 | F-002確認 |

エラーログ:
| 発生日時 | 種別 | ステップ | メッセージ |
|---------|------|---------|----------|
| 2026-01-21 14:35 | SESSION_DISCONNECT | 設計完了後 | - |

【リカバリ方法】
特定のタスクをリカバリするには:
/aipm-recover AI_PM_PJ 178
```

### リカバリ実行モード

```
/aipm-recover AI_PM_PJ 178

【リカバリ対象】TASK_178: チェックポイント記録追加

【最終チェックポイント】
- ステップ: 設計完了
- 時刻: 2026-01-21 14:30
- 次のアクション: 実装開始
- メモ: aipm-worker.md編集箇所特定済み

【エラー情報】
- 発生日時: 2026-01-21 14:35
- 種別: SESSION_DISCONNECT
- ステップ: 設計完了後
- メッセージ: -

【選択肢】
A. 最終チェックポイントから再開（推奨）
   → 「実装開始」から作業を継続
   → ステータス: INTERRUPTED → IN_PROGRESS
B. タスクをやり直し
   → 進捗をリセットして最初から実行
   → ステータス: INTERRUPTED → QUEUED
C. タスクをキャンセル
   → タスクを完全に中止
   → ステータス: INTERRUPTED → CANCELLED

どのオプションを選択しますか？ [A/B/C]

User: A

【リカバリ完了】TASK_178を再開しました。

最終チェックポイント: 設計完了
次のアクション: 実装開始

DBタスク更新:
- ステータス: INTERRUPTED → IN_PROGRESS
- 担当: Worker A

作業を継続してください:
/aipm-worker AI_PM_PJ 178
```

### 中断タスクなしの場合

```
/aipm-recover AI_PM_PJ

【中断タスク状況】プロジェクト: AI_PM_PJ

中断中のタスクはありません。

【現在の状況】
- 実行中タスク: TASK_178 (Worker A), TASK_179 (Worker B)
- 待機中タスク: なし

タスクを開始するには:
/aipm-worker AI_PM_PJ {TASK_ID}
```

---

## 後方互換性

- DBにINTERRUPTEDステータスのタスクがない場合：「中断タスクなし」と表示
- DBスクリプトが利用できない場合：エラー表示しDBスクリプトの修復を促す
- チェックポイント情報がDBにない場合：「情報なし」と表示
- エラーログセクションがない場合：エラーログ表示をスキップ

---

## 関連コマンド

| コマンド | 用途 |
|---------|------|
| `/aipm-status` | プロジェクト状態確認（中断タスク表示含む） |
| `/aipm-worker` | タスク実行（リカバリ後の作業継続） |
| `/aipm-pm` | PMとしてORDER管理 |

---

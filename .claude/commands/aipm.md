---
description: AI PM フレームワーク自動起動 - プロジェクト状態を分析し、次のアクションをガイド（マルチORDER対応）
allowed-tools: Glob(**/*.md), Read(**/README.md), Read(**/.framework/BOOTSTRAP.md), Read(**/ORDER_*.md), Bash(python backend/*)
---

# AI PM フレームワーク自動起動

AI PM フレームワークを起動します。以下の手順を自動実行してください：

**引数**:
- 第1引数: プロジェクト名（オプション、例: AI_PM_PJ）
- `--all`: 非アクティブプロジェクトも含めて表示

引数が提供された場合、以下のように解析してください：
- `AI_PM_PJ` を `$PROJECT_NAME` として使用
- `--all` を含む場合: 非アクティブプロジェクトも表示
- 引数なしの場合: アクティブプロジェクトのみスキャン（デフォルト動作）

---

## Step 0: 引数チェック

引数の有無を確認し、動作モードを決定：

| 引数 | 動作モード | 処理内容 |
|------|-----------|---------|
| `PROJECT_NAME` | 単一プロジェクト | DBから指定プロジェクトの状態を取得 |
| なし | 全プロジェクト | アクティブプロジェクトのみ表示（デフォルト） |
| `--all` | 全プロジェクト（全件） | 非アクティブプロジェクトも含めて表示 |

### --all オプションについて

`--all` オプションは非アクティブプロジェクト（アーカイブ済み、一時停止中など）も含めて表示するためのオプションです。

**デフォルト動作（--all なし）**:
- `is_active = True` のプロジェクトのみ表示
- 過去に完了した非アクティブプロジェクトは非表示

**--all 指定時**:
- `is_active` に関係なく全プロジェクトを表示
- 非アクティブプロジェクトには `(inactive)` マークを付与

---

## Step 0.5: データソース判定（DB中心アーキテクチャ対応）

データ取得先を判定し、DB優先でプロジェクト状態を取得します。

### 0.5.1 DB利用可能判定

以下の条件を順に確認：

```
DB利用可能判定:
1. backend/ ディレクトリが存在するか確認
2. data/aipm.db ファイルが存在するか確認
3. 両方存在 → DBモード
4. いずれか存在しない → 従来方式（Markdown直接読み込み）
```

### 0.5.2 DBモードでのデータ取得

DBが利用可能な場合、以下のスクリプトでプロジェクト状態を取得：

**単一プロジェクトモード（引数あり）**:

```bash
# アクティブORDER一覧を取得（進捗・実行中タスク含む）
python backend/order/list.py $PROJECT_NAME --active --json

# 実行中タスク一覧を取得
python backend/task/list.py $PROJECT_NAME --status IN_PROGRESS --json
```

**全プロジェクトモード（引数なし）**:

```bash
# デフォルト: アクティブプロジェクトのみ取得
python backend/project/list.py --json

# --all オプション: 全プロジェクト取得（非アクティブ含む）
python backend/project/list.py --all --json
```

### 0.5.3 フォールバック処理

DBスクリプト実行に失敗した場合、または DB が存在しない場合は従来方式にフォールバック：

```
フォールバック条件:
1. backend/ が存在しない
2. data/aipm.db が存在しない
3. DBスクリプトがエラーで終了（exit code != 0）
4. DBスクリプトの出力が空またはパースエラー

フォールバック時の動作:
→ プロジェクトディレクトリの存在確認のみ実施
→ Step 1 の処理に進む（限定的な情報で表示）
```

### 0.5.4 データソースインジケータ表示（オプション）

データ取得元を表示する場合のフォーマット：

```
【データソース】
- モード: DB優先
- DB: ✓ (data/aipm.db)
- スクリプト: ✓ (backend/)
```

または（フォールバック時）:

```
【データソース】
- モード: Markdown直接読み込み
- 理由: DBスクリプトが利用不可
```

### 0.5.5 DBモードでの表示データ構築

DBから取得したデータを従来の表示フォーマットに変換：

| DB項目 | 表示項目 |
|--------|---------|
| `order.id` | ORDER ID |
| `order.title` | ORDERタイトル |
| `order.status` | ステータス |
| `order.priority` | 優先度 |
| `order.progress_percent` | 進捗率 |
| `order.in_progress_task` | 実行中タスク |
| `task.id` | 次のタスク（QUEUED/BLOCKEDから選択） |

---

## Step 1: プロジェクト検索

### DBモードでの処理（Step 0.5でDB利用可能と判定された場合）

DBモードでは、プロジェクト存在確認後、DBスクリプトでデータを取得：

```
DBモードの処理フロー:
1. PROJECTS/$PROJECT_NAME/ の存在確認
2. 存在する場合:
   a. python backend/order/list.py $PROJECT_NAME --active --json を実行
   b. 成功 → DBデータを使用してStep 3へ
   c. 失敗 → フォールバック（従来方式）
3. 存在しない場合:
   → エラーメッセージ表示
```

### 引数ありの場合（単一プロジェクトモード）

1. `PROJECTS/$PROJECT_NAME/` ディレクトリの存在を確認
2. **存在する場合**:
   - **DBモード**: `order/list.py --active` でアクティブORDER取得、Step 3へ
   - **フォールバック**: DBが利用不可の場合、プロジェクトディレクトリ情報のみで表示
3. **存在しない場合**: 以下のエラーメッセージを表示して終了

```
エラー: プロジェクト '$PROJECT_NAME' が見つかりません。

利用可能なプロジェクト:
（python backend/project/list.py --json の結果からプロジェクト名を列挙）

使用方法:
/aipm [PROJECT_NAME]

例:
/aipm AI_PM_PJ    # 指定プロジェクトのみ表示
/aipm             # 全プロジェクトを表示
```

### 引数なしの場合（全プロジェクトモード）

**DBモード（推奨）**:
1. `python backend/project/list.py --json` でアクティブプロジェクト一覧を取得
2. `--all` オプションが指定された場合は `--all` フラグを追加
3. 取得したプロジェクト一覧を表示、Step 2 へ

**フォールバック（DBスクリプト利用不可時）**:
1. `Glob PROJECTS/*/` でプロジェクトディレクトリを検索
2. 各プロジェクトのディレクトリ存在を確認
3. ※ フォールバック時は詳細情報が取得できないため、DBセットアップを推奨

---

## Step 2: フレームワーク README の読み込み
フレームワークREADMEを読み込み、自動起動トリガーを理解してください：
- パス: `README.md`

---

## Step 3: プロジェクト状態の判定・アクション提示

### DBモードでの状態判定

DBモードの場合、`order/list.py --active` の結果から状態を判定：

```
DBモードでの状態判定:
1. アクティブORDER数が0 → COMPLETED または INITIAL
   - 全ORDER完了済み → COMPLETED
   - ORDERなし → INITIAL
2. アクティブORDER数が1以上 → IN_PROGRESS
   - ORDER.statusを確認（PLANNING/IN_PROGRESS/REVIEW）
```

**次のタスク取得**（DBモード）:

```bash
# QUEUEDまたはBLOCKEDのタスクを優先度順で取得
python backend/task/list.py $PROJECT_NAME --status QUEUED --limit 1 --json
```

### フォールバック時の状態判定

DBが利用できない場合は、プロジェクトディレクトリ情報のみで状態を推定：

| 判定条件 | 推定ステータス | アクション |
|----------|---------------|-----------|
| `RESULT/ORDER_*/` が存在しない | `INITIAL` | ユーザーにORDER_001.mdの記入を促す |
| `RESULT/ORDER_*/` が存在 | `IN_PROGRESS` | DB登録を促す |

**推奨**: フォールバック時は正確な状態判定ができないため、DBのセットアップを推奨してください。

---

## Step 3.5: マルチORDERモード判定（新規）

DBから取得したアクティブORDER数に基づいて、複数ORDER同時進行モードかどうかを判定：

### 判定ロジック

```
1. `order/list.py --active` の結果からアクティブORDER数を取得
2. アクティブORDER数に基づく分岐:
   - 0件: 「アクティブORDERがありません」→ 新規ORDER作成を提案
   - 1件: 単一ORDERモードとして動作（従来動作）
   - 2件以上: マルチORDERナビゲーション（Step 3.6へ）
```

---

## Step 3.6: マルチORDERナビゲーション（新規）

複数のアクティブORDERがある場合、以下の情報を収集・表示：

### 3.6.1 ORDER状況の収集

各アクティブORDERから以下を収集：
- ORDER ID
- タイトル
- 優先度（P0/P1/P2/P3）
- 進捗率
- ステータス
- レビュー待ちタスク数

### 3.6.2 推奨アクションの決定

以下の優先順位で推奨アクションを決定：

| 優先度 | 条件 | 推奨アクション |
|--------|------|----------------|
| 1 | P0（緊急）のORDERあり | 緊急対応を最優先 |
| 2 | レビュー待ちタスクあり | レビュー実施を提案 |
| 3 | 完了間近（80%以上）のORDERあり | 完了を優先 |
| 4 | 優先度順 | P1 > P2 > P3 の順に提案 |

### 3.6.3 ORDER間依存関係の警告

DBから取得したORDER依存関係情報を確認し：
- **NOT_SATISFIED**の依存がある場合は警告表示
- 依存先ORDERの完了状況を表示
- ブロックされているORDERを明示

### 3.6.4 マルチORDERナビゲーション表示フォーマット

```
## AI PM Framework - マルチORDERモード

### アクティブORDER一覧

| ORDER | タイトル | 優先度 | 進捗 | ステータス |
|-------|---------|--------|------|----------|
| ORDER_019 | 複数ORDER同時進行 | P1 | 44% | IN_PROGRESS |
| ORDER_020 | ドキュメント整備 | P2 | 83% | IN_PROGRESS |

### 推奨アクション

1. **[P1] ORDER_019**: 複数ORDER同時進行（進行中）
   - 次のタスク: TASK_152（aipm-pm.md更新）
   - コマンド: `/aipm-worker AI_PM_PJ 152`

2. **[P2] ORDER_020**: ドキュメント整備（完了間近 83%）
   - 次のタスク: TASK_207（最終確認）
   - コマンド: `/aipm-worker AI_PM_PJ 207`

### 依存関係警告（該当がある場合のみ表示）

⚠️ 以下のORDERは依存関係により待機中です：
- ORDER_022 は ORDER_019 の完了を待機中（FINISH_TO_START）

### 選択肢

どのORDERを対象にしますか？
- A. ORDER_019を続行（優先度高）
- B. ORDER_020を完了させる（完了間近）
- C. 全ORDER状況を確認 (`/aipm-status AI_PM_PJ`)
- D. 特定ORDERのタスクを直接指定
```

---

## Step 4: ユーザーをガイド
現在の状態に基づいて、明確で実行可能な次のステップを日本語で提示してください。

**出力形式例（単一プロジェクト指定時）**:
```
## AI PM Framework - 現在の状態

### プロジェクト: AI_PM_PJ
- ステータス: IN_PROGRESS
- ORDER: ORDER_014 (スラッシュコマンド改善 v1.12.0)
- 進捗: 1/6タスク完了

---

## 次のアクション

次のタスク: TASK_069（/aipmスキルの日本語化）

以下のコマンドで継続できます：
/aipm-worker AI_PM_PJ 069
```

**出力形式例（全プロジェクトスキャン時）**:
```
## AI PM Framework - 現在の状態

2つのアクティブなプロジェクトを検出しました：

### プロジェクト1: AI_PM_PJ
- ステータス: IN_PROGRESS
- ORDER: ORDER_014 (スラッシュコマンド改善 v1.12.0)
- 進捗: 1/6タスク完了

### プロジェクト2: SIS_batch_investigation
- ステータス: COMPLETED
- ORDER: ORDER_003 (PostgreSQLトランザクションエラー修正)

---

## 次のアクション

AI_PM_PJ プロジェクトでタスクが進行中です：
- 次のタスク: TASK_069（/aipmスキルの日本語化）

以下のコマンドで継続できます：
/aipm-worker AI_PM_PJ 069
```

**出力形式例（--all オプション指定時）**:
```
## AI PM Framework - 現在の状態

全プロジェクト一覧（アクティブ + 非アクティブ）：

### アクティブプロジェクト

| ID | 名前 | ステータス | 進捗 |
|----|------|------------|------|
| AI_PM_PJ | AI PM Framework | IN_PROGRESS | 75% |
| SIS_batch | バッチ調査 | REVIEW | 100% |

### 非アクティブプロジェクト

| ID | 名前 | ステータス | 理由 |
|----|------|------------|------|
| Old_Project | 旧プロジェクト (inactive) | COMPLETED | アーカイブ済み |
| Test_PJ | テストプロジェクト (inactive) | ON_HOLD | 一時停止中 |

---

## 補足

非アクティブプロジェクトはデフォルトでは非表示です。
`/aipm` でアクティブプロジェクトのみ表示されます。
```

**出力形式例（マルチORDERモード時）**:
```
## AI PM Framework - マルチORDERモード

### プロジェクト: AI_PM_PJ
- ステータス: IN_PROGRESS
- アクティブORDER: 3件

### アクティブORDER一覧

| ORDER | タイトル | 優先度 | 進捗 | ステータス |
|-------|---------|--------|------|----------|
| ORDER_021 | 緊急バグ修正 | P0 | 0% | QUEUED |
| ORDER_019 | 複数ORDER同時進行 | P1 | 44% | IN_PROGRESS |
| ORDER_020 | ドキュメント整備 | P2 | 83% | IN_PROGRESS |

### 推奨アクション

🚨 **緊急対応が必要です**

1. **[P0] ORDER_021**: 緊急バグ修正
   - 次のタスク: TASK_210（バグ調査）
   - コマンド: `/aipm-worker AI_PM_PJ 210`

2. **[P2] ORDER_020**: ドキュメント整備（完了間近 83%）
   - 次のタスク: TASK_207（最終確認）
   - コマンド: `/aipm-worker AI_PM_PJ 207`

### 依存関係警告

⚠️ 以下のORDERは依存関係により待機中です：
- ORDER_022 は ORDER_019 の完了を待機中（FINISH_TO_START）

---

どのORDERを対象にしますか？
- A. ORDER_021を開始（緊急P0）
- B. ORDER_020を完了させる（完了間近）
- C. ORDER_019を続行
- D. 全ORDER状況を確認 (`/aipm-status AI_PM_PJ`)
```

---

## 実行例

### 1. 特定プロジェクトを指定して起動
```
/aipm AI_PM_PJ
```
→ AI_PM_PJ プロジェクトの状態のみを表示

### 2. アクティブプロジェクトをスキャンして起動（デフォルト動作）
```
/aipm
```
→ アクティブプロジェクトのみスキャンして状態を表示
→ `is_active = True` のプロジェクトのみ

### 2.1 全プロジェクトを表示（非アクティブ含む）
```
/aipm --all
```
→ PROJECTS/ 配下の全プロジェクトをスキャンして状態を表示
→ 非アクティブプロジェクトには `(inactive)` マークを付与

### 3. マルチORDERプロジェクトの起動
```
/aipm AI_PM_PJ
```
→ 複数のアクティブORDERがある場合、マルチORDERナビゲーションを表示
→ 優先度順、完了間近順で推奨アクションを提示
→ ORDER間依存関係の警告を表示

### 4. DBモードでの起動（v1.25.0+）
```
/aipm AI_PM_PJ
```
→ `backend/` と `data/aipm.db` が存在する場合、自動的にDBモードで起動
→ DBから直接アクティブORDER・タスク情報を取得
→ 高速・正確なプロジェクト状態の表示

**DBモードでの内部処理**:
```bash
# 1. アクティブORDER取得
python backend/order/list.py AI_PM_PJ --active --json

# 2. 実行中タスク取得（必要に応じて）
python backend/task/list.py AI_PM_PJ --status IN_PROGRESS --json

# 3. 次のタスク取得（QUEUEDから）
python backend/task/list.py AI_PM_PJ --status QUEUED --limit 1 --json
```

### 5. フォールバック動作
```
/aipm AI_PM_PJ
```
→ DBが利用できない場合、プロジェクトディレクトリ情報のみで限定的に表示
→ 完全な情報表示にはDBセットアップが必要

---

## 後方互換性

### DB中心アーキテクチャとの互換性

| 条件 | データソース | 動作 |
|------|-------------|------|
| `backend/` + `data/aipm.db` 存在 | DB優先 | DBスクリプト経由でデータ取得 |
| DBスクリプト実行エラー | フォールバック | プロジェクトディレクトリ情報のみで限定表示 |
| DBなし（旧環境） | 限定情報 | DBセットアップを推奨（TEMPLATE/SETUP.md参照） |

### is_active フィルタリングについて

| オプション | 動作 | 用途 |
|-----------|------|------|
| なし | アクティブプロジェクトのみ表示（デフォルト） | 日常の作業時 |
| `--all` | 全プロジェクト表示（非アクティブ含む） | 過去プロジェクト確認時 |

**注意**: 従来方式（Markdownフォールバック）では `is_active` フィルタは適用されません。

### 単一ORDERモードとマルチORDERモードの自動判定

| 条件 | 動作モード |
|------|-----------|
| DBのアクティブORDER数が0件 | 新規ORDER作成を促す |
| DBのアクティブORDER数が1件 | 単一ORDERモード |
| DBのアクティブORDER数が2件以上 | マルチORDERナビゲーション |

既存プロジェクトは自動的に単一ORDERモードで動作し、破壊的変更なく利用可能です。
DB中心アーキテクチャは必須となり、DBがない環境ではセットアップを推奨します。

---

**注**: このコマンドはフレームワーク README.md を読み込みます。README には完全な自動起動ロジックが含まれており、起動プロセス全体をガイドします。
